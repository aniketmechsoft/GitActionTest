name: Selenium Automation

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      suite:
        description: "Select Test Suite"
        required: true
        default: smoke1
        type: choice
        options:
          - smoke1
          - regression1
          - sanity

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1

    - name: Decide Suite
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "SUITE=regression1" >> $GITHUB_ENV
        else
          echo "SUITE=${{ github.event.inputs.suite }}" >> $GITHUB_ENV
        fi

    - name: Run Selected Suite
      run: |
        mvn clean test \
          -DsuiteFile=src/test/resources/${SUITE}.xml \
          -Dmaven.test.failure.ignore=true

    - name: Check pass percentage (exclude skipped)
      if: always()
      run: |
        REPORT=target/surefire-reports/testng-results.xml
        SUMMARY_FILE=target/test-summary.txt
        THRESHOLD=50

        TOTAL=$(grep -o 'total="[0-9]*"' $REPORT | grep -o '[0-9]*')
        PASSED=$(grep -o 'passed="[0-9]*"' $REPORT | grep -o '[0-9]*')
        SKIPPED=$(grep -o 'skipped="[0-9]*"' $REPORT | grep -o '[0-9]*')

        EFFECTIVE_TOTAL=$(( TOTAL - SKIPPED ))

        if [ "$EFFECTIVE_TOTAL" -le 0 ]; then
          echo "âŒ No executed tests. Failing pipeline."
          exit 1
        fi

        PASS_PERCENT=$(( PASSED * 100 / EFFECTIVE_TOTAL ))

        echo "========== TEST SUMMARY =========="
        echo "Suite           : $SUITE"
        echo "Total Tests     : $TOTAL"
        echo "Skipped Tests   : $SKIPPED"
        echo "Executed Tests  : $EFFECTIVE_TOTAL"
        echo "Passed Tests    : $PASSED"
        echo "Pass Percentage : $PASS_PERCENT%"
        echo "================================="

        if [ "$PASS_PERCENT" -lt "$THRESHOLD" ]; then
          echo "âŒ Pass percentage below 50%. Failing pipeline."
          exit 1
        else
          echo "âœ… Pass percentage meets threshold."
        fi

    - name: Upload TestNG Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TestNG-Reports
        path: target/surefire-reports
        

    - name: Zip Extent Reports
      if: always()
      run: |
        echo "Waiting for extent report generation..."
        sleep 5

        if [ -d "target/extent-reports" ]; then
        cd target
        zip -r extent-reports.zip extent-reports
        echo "Zipped report: extent-reports.zip"
        else
        echo "âŒ extent-reports folder not found"
        exit 1
        fi

    - name: Upload Extent Reports ZIP
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Extent-Reports
        path: target/extent-reports.zip
        
  # Artifact link
    - name: Set Artifact Link
      if: always()
      run: |
        echo "ARTIFACT_LINK=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV

    - name: Send Automation Report Email
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
       server_address: smtp.gmail.com
       server_port: 587
       secure: false

       username: ${{ secrets.EMAIL_USER }}
       password: ${{ secrets.EMAIL_PASS }}

       subject: "Automation Suite â€“ ${{ job.status }}"

       body: |
        Automation Execution Summary

        Status: ${{ job.status }}

        $(cat target/test-summary.txt)

        -----------------------------
        ðŸ“Š How to view detailed report
        -----------------------------
        1. Open the link below
        2. Go to "Artifacts"
        3. Download the Extent Report ZIP
        4. Extract zip
        5. Open Web folder
        6. Open index.html

        Report Link:
          ${{ env.ARTIFACT_LINK }}

       to: aniketdhandar111@gmail.com
       from: Automation CI
